<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneHub's Blog</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    
    <!-- Bootstrap Icons -->
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-icons/1.8.1/font/bootstrap-icons.css" type="text/css" rel="stylesheet" />
    
    <!-- Highlight.js CSS -->
    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/styles/github-dark.min.css" type="text/css" rel="stylesheet" />
    
    <style>
        .blog-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        
        .blog-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .blog-card img {
            height: 180px;
            object-fit: cover;
        }
        
        .blog-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .blog-content pre {
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .blog-content code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        
        .blog-content img {
            max-width: 100%;
            height: auto;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .search-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f8f9fa;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .lazy-loaded {
            opacity: 1;
        }
        
        .modal-header, .modal-footer {
            border: none;
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .no-results {
            text-align: center;
            padding: 50px 0;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <div class="d-flex align-items-center text-dark text-decoration-none">
                <i class="bi bi-journal-text fs-4 me-2"></i>
                <span class="fs-4">OneHub's Blog</span>
            </div>
        </header>
        
        <div class="search-container">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="搜索博客文章...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">清除</button>
            </div>
        </div>
        
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
        
        <div id="noResults" class="no-results d-none">
            <i class="bi bi-emoji-frown fs-1"></i>
            <p class="mt-3">没有找到匹配的博客文章</p>
        </div>
        
        <div id="blogContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <!-- 博客卡片将在这里动态加载 -->
        </div>
        
        <footer class="pt-4 my-5 text-muted border-top">
            <p>博客内容托管于 <a href="https://github.com/" target="_blank">GitHub</a></p>
            <p>&copy; 2019 - 2025 liuxiaolong01.github.io | 基于Bootstrap构建</p>
        </footer>
    </div>
    
    <!-- 博客内容模态框 -->
    <div class="modal fade" id="blogModal" tabindex="-1" aria-labelledby="blogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blogModalLabel">博客标题</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="blogContent" class="blog-content">
                        <!-- 博客内容将在这里动态加载 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/js/bootstrap.bundle.min.js" type="application/javascript"></script>
    
    <!-- jQuery -->
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Marked.js -->
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.js" type="application/javascript"></script>
    
    <!-- Highlight.js -->
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/highlight.min.js" type="application/javascript"></script>
    
    <script>
        // 配置变量
        const config = {
            githubApi: {
                username: 'liuxiaolong01',
                repo: 'liuxiaolong01.github.io',
                directory: 'blog',
                token: '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'
            },
            coverImageApi: 'https://api.imlcd.cn/bg/gq.php'
        };
        
        // 存储博客数据
        let blogPosts = [];
        
        // 初始化marked.js
        marked.setOptions({
            highlight: function(code, lang) {
                return hljs.highlightAuto(code, [lang]).value;
            },
            breaks: true,
            gfm: true
        });
        
        // 获取GitHub仓库中的文件
        async function fetchBlogFiles() {
            try {
                const apiUrl = `https://api.github.com/repos/${config.githubApi.username}/${config.githubApi.repo}/contents/${config.githubApi.directory}`;
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${config.githubApi.token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const files = await response.json();
                const mdFiles = files.filter(file => file.name.endsWith('.md'));
                
                // 获取每个文件的详细内容
                for (const file of mdFiles) {
                    const contentResponse = await fetch(file.download_url);
                    if (!contentResponse.ok) {
                        throw new Error(`获取文件内容失败: ${file.name}`);
                    }
                    
                    const content = await contentResponse.text();
                    // 从文件内容中提取标题
                    let title = file.name.replace('.md', '');
                    
                    // 尝试从Markdown内容中提取标题
                    const titleMatch = content.match(/^# (.+)$/m);
                    if (titleMatch && titleMatch[1]) {
                        title = titleMatch[1];
                    }
                    
                    blogPosts.push({
                        id: file.sha,
                        title: title,
                        content: content,
                        path: file.path,
                        url: file.html_url
                    });
                }
                
                // 按文件名排序，最新的在前面
                blogPosts.sort((a, b) => {
                    const aName = a.path.replace('.md', '');
                    const bName = b.path.replace('.md', '');
                    return bName.localeCompare(aName);
                });
                
                return blogPosts;
            } catch (error) {
                console.error('获取博客文件失败:', error);
                document.getElementById('loadingSpinner').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        加载博客失败: ${error.message}
                    </div>
                `;
                return [];
            }
        }
        
        // 创建博客卡片
        function createBlogCard(blog) {
            const randomSeed = Math.random().toString(36).substring(2, 10);
            const coverUrl = `${config.coverImageApi}?${randomSeed}`;
            
            const card = document.createElement('div');
            card.className = 'col';
            card.innerHTML = `
                <div class="card blog-card h-100" data-id="${blog.id}">
                    <img src="${coverUrl}" class="card-img-top lazy-load" alt="${blog.title}" loading="lazy">
                    <div class="card-body">
                        <h5 class="card-title">${blog.title}</h5>
                    </div>
                </div>
            `;
            
            // 添加点击事件
            card.querySelector('.blog-card').addEventListener('click', () => {
                showBlogContent(blog);
            });
            
            return card;
        }
        
        // 显示博客内容
        function showBlogContent(blog) {
            const modalTitle = document.getElementById('blogModalLabel');
            const blogContent = document.getElementById('blogContent');
            
            modalTitle.textContent = blog.title;
            
            // 将Markdown转换为HTML
            const htmlContent = marked.parse(blog.content);
            blogContent.innerHTML = htmlContent;
            
            // 应用代码高亮
            document.querySelectorAll('#blogContent pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // 显示模态框
            const blogModal = new bootstrap.Modal(document.getElementById('blogModal'));
            blogModal.show();
        }
        
        // 搜索功能
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            const noResults = document.getElementById('noResults');
            const blogContainer = document.getElementById('blogContainer');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const cards = blogContainer.querySelectorAll('.col');
                let hasResults = false;
                
                cards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    if (title.includes(searchTerm) || searchTerm === '') {
                        card.style.display = '';
                        hasResults = true;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                if (hasResults || searchTerm === '') {
                    noResults.classList.add('d-none');
                } else {
                    noResults.classList.remove('d-none');
                }
            });
            
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
            });
        }
        
        // 懒加载图片
        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const lazyImages = document.querySelectorAll('.lazy-load');
                
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src || img.src;
                            img.addEventListener('load', () => {
                                img.classList.add('lazy-loaded');
                            });
                            observer.unobserve(img);
                        }
                    });
                });
                
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // 回退方案
                const lazyImages = document.querySelectorAll('.lazy-load');
                lazyImages.forEach(img => {
                    img.src = img.dataset.src || img.src;
                    img.classList.add('lazy-loaded');
                });
            }
        }
        
        // 流式加载博客卡片
        function setupInfiniteScroll() {
            const blogContainer = document.getElementById('blogContainer');
            let visibleCount = 0;
            const batchSize = 6;
            
            function loadMoreBlogs() {
                const newCards = [];
                const endIndex = Math.min(visibleCount + batchSize, blogPosts.length);
                
                for (let i = visibleCount; i < endIndex; i++) {
                    newCards.push(createBlogCard(blogPosts[i]));
                }
                
                if (newCards.length > 0) {
                    newCards.forEach(card => blogContainer.appendChild(card));
                    visibleCount += newCards.length;
                    setupLazyLoading();
                }
                
                if (visibleCount >= blogPosts.length) {
                    const loadingSpinner = document.getElementById('loadingSpinner');
                    loadingSpinner.style.display = 'none';
                }
            }
            
            // 初始加载
            loadMoreBlogs();
            
            // 监听滚动事件
            window.addEventListener('scroll', () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                    loadMoreBlogs();
                }
            });
        }
        
        // 初始化应用
        async function initApp() {
            // 获取博客文件
            blogPosts = await fetchBlogFiles();
            
            if (blogPosts.length > 0) {
                // 设置搜索功能
                setupSearch();
                
                // 设置流式加载
                setupInfiniteScroll();
                
                // 设置懒加载
                setupLazyLoading();
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
