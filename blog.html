<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneHub's Blog</title>
    <!-- Bootstrap CSS -->
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-icons/1.8.1/font/bootstrap-icons.css" type="text/css" rel="stylesheet" />
    <!-- Highlight.js CSS -->
    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/styles/github.min.css" type="text/css" rel="stylesheet" />
    <style>
        /* 自定义样式 */
        .card {
            transition: transform 0.3s;
            margin-bottom: 20px;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-img-top {
            height: 180px;
            object-fit: cover;
        }
        .modal-body img {
            max-width: 100%;
            height: auto;
        }
        pre {
            padding: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        code {
            padding: 2px 4px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #searchInput {
            max-width: 300px;
        }
        .lazy {
            background-color: #f8f9fa;
            min-height: 180px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">OneHub's Blog</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- 可以添加更多导航项 -->
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" id="searchInput" placeholder="搜索文章..." aria-label="Search">
                </form>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container mt-4">
        <div class="row" id="blogContainer">
            <!-- 博客卡片将在这里动态加载 -->
        </div>
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- 博客内容模态框 -->
    <div class="modal fade" id="blogModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blogModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="blogModalContent">
                    <!-- 博客内容将在这里动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container text-center">
            <p>博客内容托管于 <a href="https://github.com/" target="_blank" class="text-white">GitHub</a></p>
            <p>&copy; 2019 - 2025 liuxiaolong01.github.io | 基于Bootstrap构建</p>
        </div>
    </footer>

    <!-- JavaScript 库 -->
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/5.1.3/js/bootstrap.bundle.min.js" type="application/javascript"></script>
    <!-- 修改了marked.js的加载方式 -->
    <script src="https://fastly.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/highlight.js/11.4.0/highlight.min.js" type="application/javascript"></script>

    <script>
        // 配置变量
        const githubApi = 'https://api.github.com/repos/liuxiaolong01/liuxiaolong01.github.io/contents/blog?ref=gh-pages';
        const coverImageApi = 'https://api.imlcd.cn/bg/gq.php';
        
        // 确保marked加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 加载博客列表
            loadBlogList();
            
            // 设置marked配置
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(lang, code).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            // 搜索功能
            $('#searchInput').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = $(this).val().toLowerCase();
                    filterBlogs(searchTerm);
                }
            });
        });
        
        // 加载博客列表
        function loadBlogList() {
            $('#loadingIndicator').show();
            
            fetch(githubApi)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(files => {
                    // 过滤出.md文件
                    const mdFiles = files.filter(file => 
                        file.name.endsWith('.md') && file.type === 'file'
                    );
                    
                    if (mdFiles.length === 0) {
                        $('#blogContainer').html('<div class="col-12 text-center"><p>没有找到博客文章</p></div>');
                        return;
                    }
                    
                    // 渲染博客卡片
                    renderBlogCards(mdFiles);
                    $('#loadingIndicator').hide();
                    
                    // 初始化懒加载
                    initLazyLoad();
                })
                .catch(error => {
                    console.error('获取博客列表失败:', error);
                    $('#blogContainer').html('<div class="col-12 text-center"><p>加载博客列表失败，请稍后再试</p></div>');
                    $('#loadingIndicator').hide();
                });
        }
        
        // 渲染博客卡片
        function renderBlogCards(blogs) {
            const blogContainer = $('#blogContainer');
            blogContainer.empty();
            
            blogs.forEach(blog => {
                const blogName = blog.name.replace('.md', '');
                const blogUrl = blog.download_url;
                const randomCover = `${coverImageApi}?random=${Math.random()}`;
                
                const blogCard = `
                    <div class="col-lg-4 col-md-6 col-sm-12 blog-card" data-title="${blogName.toLowerCase()}" data-url="${blogUrl}">
                        <div class="card h-100">
                            <img data-src="${randomCover}" class="card-img-top lazy" alt="${blogName}">
                            <div class="card-body">
                                <h5 class="card-title">${blogName}</h5>
                            </div>
                            <div class="card-footer bg-transparent">
                                <button class="btn btn-primary btn-sm read-more" data-url="${blogUrl}" data-title="${blogName}">阅读更多</button>
                            </div>
                        </div>
                    </div>
                `;
                
                blogContainer.append(blogCard);
            });
            
            // 绑定点击事件
            $('.read-more').on('click', function() {
                const blogUrl = $(this).data('url');
                const blogTitle = $(this).data('title');
                loadBlogContent(blogUrl, blogTitle);
            });
        }
        
        // 加载博客内容
        function loadBlogContent(url, title) {
            $('#blogModalTitle').text(title);
            $('#blogModalContent').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            
            const blogModal = new bootstrap.Modal(document.getElementById('blogModal'));
            blogModal.show();
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.text();
                })
                .then(markdown => {
                    // 转换Markdown为HTML
                    const htmlContent = marked.parse(markdown);
                    $('#blogModalContent').html(htmlContent);
                    
                    // 高亮代码块
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    
                    // 确保图片适应模态框
                    $('#blogModalContent img').addClass('img-fluid');
                })
                .catch(error => {
                    console.error('获取博客内容失败:', error);
                    $('#blogModalContent').html('<div class="alert alert-danger">加载博客内容失败，请稍后再试</div>');
                });
        }
        
        // 过滤博客
        function filterBlogs(searchTerm) {
            $('.blog-card').each(function() {
                const blogTitle = $(this).data('title');
                if (blogTitle.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        // 初始化懒加载
        function initLazyLoad() {
            const lazyImages = document.querySelectorAll('img.lazy');
            
            if ('IntersectionObserver' in window) {
                const lazyImageObserver = new IntersectionObserver(function(entries, observer) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            const lazyImage = entry.target;
                            lazyImage.src = lazyImage.dataset.src;
                            lazyImage.classList.remove('lazy');
                            lazyImageObserver.unobserve(lazyImage);
                        }
                    });
                });
                
                lazyImages.forEach(function(lazyImage) {
                    lazyImageObserver.observe(lazyImage);
                });
            } else {
                // 不支持IntersectionObserver的浏览器直接加载所有图片
                lazyImages.forEach(function(lazyImage) {
                    lazyImage.src = lazyImage.dataset.src;
                    lazyImage.classList.remove('lazy');
                });
            }
        }
    </script>
</body>
</html>